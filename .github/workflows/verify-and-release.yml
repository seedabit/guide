name: Verify, Build, Release and Deploy

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
        types:
            - opened
            - synchronize
            - reopened
            - closed

jobs:
    setup:
        name: Setup Version
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
        uses: ./.github/workflows/job-setup-node.yml
        with:
            runner: self-hosted

    package-allign:
        name: Allign package.json and package-lock.json versions
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
        runs-on: self-hosted
        needs: setup
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 24.10.0

            - name: Install dependencies
              run: npm i

    lint:
        name: Lint Codebase
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
        runs-on: self-hosted
        needs: package-allign
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 24.10.0

            - name: Cache npm
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            - name: Install dependencies
              run: npm ci

            - name: Run linter
              run: npm run lint

    build-app:
        name: Build App
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
        runs-on: self-hosted
        needs: [setup, lint]
        outputs:
            version: ${{ needs.setup.outputs.version }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 24.10.0

            - name: Cache npm
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            - name: Install dependencies
              run: npm ci

            - name: Build app
              run: npm run build

    docker-verify:
        name: Verify Docker Build (local)
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
        runs-on: self-hosted
        needs: [setup, lint, build-app]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2
              with:
                  driver: docker-container

            - name: Verify Docker build (local)
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: false
                  load: true
                  cache-to: type=gha,mode=max
                  tags: |
                      guia:verify-${{ needs.build-app.outputs.version }}

    release:
        name: Semantic Release
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
        runs-on: self-hosted
        needs: [setup, lint, build-app, docker-verify]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 24.10.0

            - name: Install dependencies
              run: npm ci

            - name: Semantic release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: npx semantic-release

    build-and-push:
        name: Build and Push Docker Image
        if: github.ref_name == 'main' && (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed'))
        needs: [setup, lint, build-app, release]
        uses: ./.github/workflows/job-docker-build-push.yml
        with:
            runner: self-hosted
            version: ${{ needs.build-app.outputs.version }}
            branch: ${{ github.ref_name }}
        secrets:
            REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
            REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
            # GITHUB_TOKEN is provided by Actions; do not pass it as a workflow_call secret

    annotate:
        name: Annotate Release (Self-Hosted)
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
        needs: [build-and-push, build-app]
        uses: ./.github/workflows/job-annotate-release.yml
        with:
            runner: self-hosted
            version: ${{ needs.build-app.outputs.version }}
            branch: ${{ github.ref_name }}
        secrets:
            REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
            REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
